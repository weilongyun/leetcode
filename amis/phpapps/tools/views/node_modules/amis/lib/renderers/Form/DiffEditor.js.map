{
    "version": 3,
    "file": "DiffEditor.js",
    "sourceRoot": "",
    "sources": [
        "/src/renderers/Form/DiffEditor.tsx"
    ],
    "names": [],
    "mappings": "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",
    "sourcesContent": [
        "import React from 'react';\nimport {Renderer} from '../../factory';\nimport {FormItem, FormControlProps, FormBaseControl} from './Item';\nimport LazyComponent from '../../components/LazyComponent';\nimport {\n  isPureVariable,\n  resolveVariableAndFilter\n} from '../../utils/tpl-builtin';\nimport {SchemaTokenizeableString} from '../../Schema';\nimport {autobind} from '../../utils/helper';\n\n/**\n * Diff 编辑器\n * 文档：https://baidu.gitee.io/amis/docs/components/form/diff\n */\nexport interface DiffControlSchema extends FormBaseControl {\n  /**\n   * 指定为 Diff 编辑器\n   */\n  type: 'diff';\n\n  /**\n   * 左侧面板的值， 支持取变量。\n   */\n  diffValue?: SchemaTokenizeableString;\n\n  /**\n   * 语言，参考 monaco-editor\n   */\n  language?: string;\n\n  /**\n   * 编辑器配置\n   */\n  options?: any;\n}\n\nfunction loadComponent(): Promise<React.ReactType> {\n  return new Promise(resolve =>\n    (require as any)(['../../components/Editor'], (component: any) =>\n      resolve(component.default)\n    )\n  );\n}\n\nexport interface DiffEditorProps\n  extends FormControlProps,\n    Omit<DiffControlSchema, 'type'> {}\n\nfunction normalizeValue(value: any, language?: string) {\n  if (value && typeof value !== 'string') {\n    value = JSON.stringify(value, null, 2);\n  }\n\n  if (language && language === 'json') {\n    try {\n      value = JSON.stringify(\n        typeof value === 'string' ? JSON.parse(value) : value,\n        null,\n        2\n      );\n    } catch (e) {}\n  }\n\n  return value;\n}\n\nexport class DiffEditor extends React.Component<DiffEditorProps, any> {\n  static defaultProps: Partial<DiffEditorProps> = {\n    language: 'javascript',\n    theme: 'vs',\n    options: {\n      automaticLayout: false,\n      selectOnLineNumbers: true,\n      scrollBeyondLastLine: false,\n      folding: true,\n      minimap: {\n        enabled: false\n      }\n    },\n    diffValue: ''\n  };\n\n  state = {\n    focused: false\n  };\n\n  editor: any;\n  monaco: any;\n  originalEditor: any;\n  modifiedEditor: any;\n  toDispose: Array<Function> = [];\n  divRef = React.createRef<HTMLDivElement>();\n\n  constructor(props: DiffEditorProps) {\n    super(props);\n\n    this.handleFocus = this.handleFocus.bind(this);\n    this.handleBlur = this.handleBlur.bind(this);\n    this.editorFactory = this.editorFactory.bind(this);\n    this.handleEditorMounted = this.handleEditorMounted.bind(this);\n    this.handleModifiedEditorChange = this.handleModifiedEditorChange.bind(\n      this\n    );\n  }\n\n  componentWillUnmount() {\n    this.toDispose.forEach(fn => fn());\n  }\n\n  handleFocus() {\n    this.setState({\n      focused: true\n    });\n  }\n\n  handleBlur() {\n    this.setState({\n      focused: false\n    });\n  }\n\n  componentDidUpdate(prevProps: any) {\n    const {data, value, diffValue, language} = this.props;\n\n    if (\n      this.originalEditor &&\n      diffValue &&\n      (diffValue !== prevProps.diffValue || data !== prevProps.data)\n    ) {\n      this.originalEditor\n        .getModel()\n        .setValue(\n          isPureVariable(diffValue as string)\n            ? normalizeValue(\n                resolveVariableAndFilter(diffValue || '', data, '| raw'),\n                language\n              )\n            : normalizeValue(diffValue, language)\n        );\n    }\n\n    if (\n      this.modifiedEditor &&\n      value &&\n      value !== prevProps.value &&\n      !this.state.focused\n    ) {\n      this.modifiedEditor.getModel().setValue(normalizeValue(value, language));\n    }\n  }\n\n  editorFactory(containerElement: any, monaco: any, options: any) {\n    return monaco.editor.createDiffEditor(containerElement, options);\n  }\n\n  handleEditorMounted(editor: any, monaco: any) {\n    const {value, data, language, diffValue} = this.props;\n\n    this.monaco = monaco;\n    this.editor = editor;\n    this.modifiedEditor = editor.getModifiedEditor();\n    this.originalEditor = editor.getOriginalEditor();\n\n    this.toDispose.push(\n      this.modifiedEditor.onDidFocusEditorWidget(this.handleFocus).dispose\n    );\n    this.toDispose.push(\n      this.modifiedEditor.onDidBlurEditorWidget(this.handleBlur).dispose\n    );\n    this.toDispose.push(\n      this.modifiedEditor.onDidChangeModelContent(\n        this.handleModifiedEditorChange\n      ).dispose\n    );\n\n    this.toDispose.push(\n      this.modifiedEditor.onDidChangeModelDecorations(() => {\n        this.updateContainerSize(this.modifiedEditor, monaco); // typing\n        requestAnimationFrame(\n          this.updateContainerSize.bind(this, this.modifiedEditor, monaco)\n        ); // folding\n      }).dispose\n    );\n\n    this.editor.setModel({\n      original: this.monaco.editor.createModel(\n        isPureVariable(diffValue as string)\n          ? normalizeValue(\n              resolveVariableAndFilter(diffValue || '', data, '| raw'),\n              language\n            )\n          : normalizeValue(diffValue, language),\n        language\n      ),\n      modified: this.monaco.editor.createModel(\n        normalizeValue(value, language),\n        language\n      )\n    });\n  }\n\n  handleModifiedEditorChange() {\n    const {onChange} = this.props;\n    onChange && onChange(this.modifiedEditor.getModel().getValue());\n  }\n\n  prevHeight = 0;\n  @autobind\n  updateContainerSize(editor: any, monaco: any) {\n    if (!this.divRef.current) {\n      return;\n    }\n\n    const lineHeight = editor.getOption(monaco.editor.EditorOption.lineHeight);\n    const lineCount = editor.getModel()?.getLineCount() || 1;\n    const height = editor.getTopForLineNumber(lineCount + 1) + lineHeight;\n\n    if (this.prevHeight !== height) {\n      this.prevHeight = height;\n      this.divRef.current.style.height = `${height}px`;\n      editor.layout();\n    }\n  }\n\n  render() {\n    const {\n      className,\n      value,\n      onChange,\n      disabled,\n      size,\n      options,\n      language,\n      theme,\n      classnames: cx\n    } = this.props;\n\n    return (\n      <div\n        ref={this.divRef}\n        className={cx(\n          'EditorControl',\n          size ? `EditorControl--${size}` : '',\n          className,\n          {\n            'is-focused': this.state.focused\n          }\n        )}\n      >\n        <LazyComponent\n          getComponent={loadComponent}\n          value={value}\n          onChange={onChange}\n          disabled={disabled}\n          language={language}\n          theme={theme}\n          editorDidMount={this.handleEditorMounted}\n          editorFactory={this.editorFactory}\n          options={{\n            ...options,\n            readOnly: disabled\n          }}\n        />\n      </div>\n    );\n  }\n}\n\n@FormItem({\n  type: `diff-editor`,\n  sizeMutable: false\n})\nexport class DiffEditorControlRenderer extends DiffEditor {\n  static defaultProps = {\n    ...DiffEditor.defaultProps\n  };\n}\n\n@Renderer({\n  test: /(^|\\/)diff-editor$/,\n  name: 'diff-editor'\n})\nexport class DiffEditorRenderer extends DiffEditor {\n  static defaultProps = {\n    ...DiffEditor.defaultProps,\n    disabled: true\n  };\n}\n"
    ]
}