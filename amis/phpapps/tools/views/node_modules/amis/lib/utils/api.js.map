{
    "version": 3,
    "file": "api.js",
    "sourceRoot": "",
    "sources": [
        "/src/utils/api.ts"
    ],
    "names": [],
    "mappings": "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",
    "sourcesContent": [
        "import {Api, ApiObject, fetcherResult, Payload} from '../types';\nimport {fetcherConfig} from '../factory';\nimport {tokenize, dataMapping} from './tpl-builtin';\nimport qs from 'qs';\nimport {evalExpression} from './tpl';\nimport {\n  isObject,\n  isObjectShallowModified,\n  hasFile,\n  object2formData,\n  qsstringify,\n  cloneObject\n} from './helper';\n\nconst rSchema = /(?:^|raw\\:)(get|post|put|delete|patch|options|head):/i;\n\ninterface ApiCacheConfig extends ApiObject {\n  cachedPromise: Promise<any>;\n  requestTime: number;\n}\n\nconst apiCaches: Array<ApiCacheConfig> = [];\n\nexport function normalizeApi(api: Api, defaultMethod?: string): ApiObject {\n  if (typeof api === 'string') {\n    let method = rSchema.test(api) ? RegExp.$1 : '';\n    method && (api = api.replace(method + ':', ''));\n\n    api = {\n      method: (method || defaultMethod) as any,\n      url: api\n    };\n  } else {\n    api = {\n      ...api\n    };\n  }\n  return api;\n}\n\nexport function buildApi(\n  api: Api,\n  data?: object,\n  options: {\n    autoAppend?: boolean;\n    ignoreData?: boolean;\n    [propName: string]: any;\n  } = {}\n): ApiObject {\n  api = normalizeApi(api, options.method);\n  const {autoAppend, ignoreData, ...rest} = options;\n\n  api.config = {\n    ...rest\n  };\n  api.method = (api.method || (options as any).method || 'get').toLowerCase();\n\n  if (!data) {\n    return api;\n  } else if (\n    data instanceof FormData ||\n    data instanceof Blob ||\n    data instanceof ArrayBuffer\n  ) {\n    api.data = data;\n    return api;\n  }\n\n  const raw = (api.url = api.url || '');\n  const idx = api.url.indexOf('?');\n\n  if (~idx) {\n    const hashIdx = api.url.indexOf('#');\n    const params = qs.parse(\n      api.url.substring(idx + 1, ~hashIdx ? hashIdx : undefined)\n    );\n    api.url =\n      tokenize(api.url.substring(0, idx + 1), data, '| url_encode') +\n      qsstringify(dataMapping(params, data)) +\n      (~hashIdx ? api.url.substring(hashIdx) : '');\n  } else {\n    api.url = tokenize(api.url, data, '| url_encode');\n  }\n\n  if (ignoreData) {\n    return api;\n  }\n\n  if (api.data) {\n    api.data = dataMapping(api.data, data);\n  } else if (api.method === 'post' || api.method === 'put') {\n    api.data = cloneObject(data);\n  }\n\n  // get 类请求，把 data 附带到 url 上。\n  if (api.method === 'get') {\n    if (!~raw.indexOf('$') && !api.data && autoAppend) {\n      api.data = data;\n    } else if (\n      api.attachDataToQuery === false &&\n      api.data &&\n      !~raw.indexOf('$') &&\n      autoAppend\n    ) {\n      const idx = api.url.indexOf('?');\n      if (~idx) {\n        let params = {\n          ...qs.parse(api.url.substring(idx + 1)),\n          ...data\n        };\n        api.url = api.url.substring(0, idx) + '?' + qsstringify(params);\n      } else {\n        api.url += '?' + qsstringify(data);\n      }\n    }\n\n    if (api.data && api.attachDataToQuery !== false) {\n      const idx = api.url.indexOf('?');\n      if (~idx) {\n        let params = {\n          ...qs.parse(api.url.substring(idx + 1)),\n          ...api.data\n        };\n        api.url = api.url.substring(0, idx) + '?' + qsstringify(params);\n      } else {\n        api.url += '?' + qsstringify(api.data);\n      }\n      delete api.data;\n    }\n  }\n\n  if (api.headers) {\n    api.headers = dataMapping(api.headers, data);\n  }\n\n  if (api.requestAdaptor && typeof api.requestAdaptor === 'string') {\n    api.requestAdaptor = str2function(api.requestAdaptor, 'api') as any;\n  }\n\n  if (api.adaptor && typeof api.adaptor === 'string') {\n    api.adaptor = str2function(\n      api.adaptor,\n      'payload',\n      'response',\n      'api'\n    ) as any;\n  }\n\n  return api;\n}\n\nfunction str2function(\n  contents: string,\n  ...args: Array<string>\n): Function | null {\n  try {\n    let fn = new Function(...args, contents);\n    return fn;\n  } catch (e) {\n    console.warn(e);\n    return null;\n  }\n}\n\nfunction responseAdaptor(ret: fetcherResult) {\n  const data = ret.data;\n\n  if (!data) {\n    throw new Error('Response is empty!');\n  } else if (!data.hasOwnProperty('status')) {\n    // 兼容不返回 status 字段的情况\n    data.status = 0;\n  }\n\n  const payload: Payload = {\n    ok: data.status == 0,\n    status: data.status,\n    msg: data.msg,\n    msgTimeout: data.msgTimeout,\n    data: !data.data && !data.hasOwnProperty('status') ? data : data.data // 兼容直接返回数据的情况\n  };\n\n  if (payload.status == 422) {\n    payload.errors = data.errors;\n  }\n\n  return payload;\n}\n\nexport function wrapFetcher(\n  fn: (config: fetcherConfig) => Promise<fetcherResult>\n): (api: Api, data: object, options?: object) => Promise<Payload | void> {\n  return function (api, data, options) {\n    api = buildApi(api, data, options) as ApiObject;\n\n    api.requestAdaptor && (api = api.requestAdaptor(api) || api);\n\n    if (api.data && (hasFile(api.data) || api.dataType === 'form-data')) {\n      api.data = object2formData(api.data, api.qsOptions);\n    } else if (\n      api.data &&\n      typeof api.data !== 'string' &&\n      api.dataType === 'form'\n    ) {\n      api.data = qsstringify(api.data, api.qsOptions) as any;\n      api.headers = api.headers || (api.headers = {});\n      api.headers['Content-Type'] = 'application/x-www-form-urlencoded';\n    } else if (\n      api.data &&\n      typeof api.data !== 'string' &&\n      api.dataType === 'json'\n    ) {\n      api.data = JSON.stringify(api.data) as any;\n      api.headers = api.headers || (api.headers = {});\n      api.headers['Content-Type'] = 'application/json';\n    }\n\n    if (typeof api.cache === 'number' && api.cache > 0) {\n      const apiCache = getApiCache(api);\n      return wrapAdaptor(\n        apiCache\n          ? (apiCache as ApiCacheConfig).cachedPromise\n          : setApiCache(api, fn(api)),\n        api\n      );\n    }\n    return wrapAdaptor(fn(api), api);\n  };\n}\n\nexport function wrapAdaptor(promise: Promise<fetcherResult>, api: ApiObject) {\n  const adaptor = api.adaptor;\n  return adaptor\n    ? promise\n        .then(async response => {\n          let result = adaptor((response as any).data, response, api);\n\n          if (result?.then) {\n            result = await result;\n          }\n\n          return {\n            ...response,\n            data: result\n          };\n        })\n        .then(responseAdaptor)\n    : promise.then(responseAdaptor);\n}\n\nexport function isApiOutdated(\n  prevApi: Api | undefined,\n  nextApi: Api | undefined,\n  prevData: any,\n  nextData: any\n): nextApi is Api {\n  const url: string =\n    (nextApi && (nextApi as ApiObject).url) || (nextApi as string);\n\n  if (nextApi && (nextApi as ApiObject).autoRefresh === false) {\n    return false;\n  }\n\n  if (url && typeof url === 'string' && ~url.indexOf('$')) {\n    prevApi = buildApi(prevApi as Api, prevData as object, {ignoreData: true});\n    nextApi = buildApi(nextApi as Api, nextData as object, {ignoreData: true});\n\n    return !!(\n      prevApi.url !== nextApi.url &&\n      isValidApi(nextApi.url) &&\n      (!nextApi.sendOn || evalExpression(nextApi.sendOn, nextData))\n    );\n  }\n\n  return false;\n}\n\nexport function isValidApi(api: string) {\n  return (\n    api &&\n    /^(?:(https?|wss?|taf):\\/\\/[^\\/]+)?(\\/[^\\s\\/\\?]*){1,}(\\?.*)?$/.test(api)\n  );\n}\n\nexport function isEffectiveApi(\n  api?: Api,\n  data?: any,\n  initFetch?: boolean,\n  initFetchOn?: string\n): api is Api {\n  if (!api) {\n    return false;\n  }\n  if (initFetch === false) {\n    return false;\n  }\n  if (initFetchOn && data && !evalExpression(initFetchOn, data)) {\n    return false;\n  }\n  if (typeof api === 'string' && api.length) {\n    return true;\n  } else if (isObject(api) && (api as ApiObject).url) {\n    if (\n      (api as ApiObject).sendOn &&\n      data &&\n      !evalExpression((api as ApiObject).sendOn as string, data)\n    ) {\n      return false;\n    }\n    return true;\n  }\n  return false;\n}\n\nexport function isSameApi(\n  apiA: ApiObject | ApiCacheConfig,\n  apiB: ApiObject | ApiCacheConfig\n): boolean {\n  return (\n    apiA.method === apiB.method &&\n    apiA.url === apiB.url &&\n    !isObjectShallowModified(apiA.data, apiB.data, false)\n  );\n}\n\nexport function getApiCache(api: ApiObject): ApiCacheConfig | undefined {\n  // 清理过期cache\n  const now = Date.now();\n  let result: ApiCacheConfig | undefined;\n\n  for (let idx = 0, len = apiCaches.length; idx < len; idx++) {\n    const apiCache = apiCaches[idx];\n\n    if (now - apiCache.requestTime > (apiCache.cache as number)) {\n      apiCaches.splice(idx, 1);\n      len--;\n      idx--;\n      continue;\n    }\n\n    if (isSameApi(api, apiCache)) {\n      result = apiCache;\n      break;\n    }\n  }\n\n  return result;\n}\n\nexport function setApiCache(\n  api: ApiObject,\n  promise: Promise<any>\n): Promise<any> {\n  apiCaches.push({\n    ...api,\n    cachedPromise: promise,\n    requestTime: Date.now()\n  });\n  return promise;\n}\n\nexport function clearApiCache() {\n  apiCaches.splice(0, apiCaches.length);\n}\n\n// window.apiCaches = apiCaches;\n"
    ]
}